<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="layui/css/layui.css" media="all">

</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin" id="app">
    <title>[[ title ]]</title>
    <div class="layui-header" id="header">
        <div class="layui-logo">[[ title ]]</div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a>
                    <img :src="user.img" class="layui-nav-img">
                    [[ user.name ]]
                </a>
            </li>
            <li class="layui-nav-item"><a href="">注销</a></li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black" id="left_side">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree layui-inline">
                <li class="layui-nav-item layui-nav-itemed">
                    <a>数据管理</a>
                    <dl class="layui-nav-child">
                        <dd><a @click="page_type='data'">数据设置</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item layui-nav-itemed">
                    <a>数据上传</a>
                    <dl class="layui-nav-child">
                        <dd><a @click="page_type='file'">普通文件上传</a></dd>
                        <dd><a @click="page_type='image'">图片上传</a></dd>
                        <dd><a @click="page_type='image'">音乐上传</a></dd>
                        <dd><a @click="page_type='image'">视频上传</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item layui-nav-itemed">
                    <a>基础设置</a>
                    <dl class="layui-nav-child">
                        <dd><a @click="page_type='base'">网站信息设置</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item layui-nav-itemed">
                    <a>安全设置</a>
                    <dl class="layui-nav-child">
                        <dd><a @click="page_type='password'">管理员信息</a></dd>
                        <dd><a @click="page_type='dev'">开发者模式</a></dd>
                    </dl>
                </li>

            </ul>
        </div>
    </div>

    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div style="padding: 0px;">
            <data_form v-show="page_type==='data'" :current_data="type_data" :stack="[]"
                       @data_change="on_data_change($event)"
                       @delete_data="on_delete_data($event)"
                       @add_new_data="on_add_new_data($event)"
                       :dev="dev">
            </data_form>
            <br/>
        </div>
    </div>

    <div class="layui-footer">
        [[ footer ]]
    </div>

</div>

<script src="vue.js"></script>
<script src="layui/layui.all.js" charset="utf-8"></script>

<script>


    layui.use(["jquery", "element", "layer", "form"], function () {
        let $ = layui.jquery;
        let element = layui.element;
        let form = layui.form;
        let layer = layui.layer;


        let data_form = Vue.component("data_form", {
                name: "data_form",
                props: ["current_data", "stack", "dev"],
                delimiters: ["[[", "]]"],
                data: function () {
                    return {
                        tmp_value: this.current_data,
                        single_line: true,
                        expand: false,
                        new_key_name: "",
                        new_type: "Number"
                    }
                },
                methods: {
                    make_index_string: function (stack) {
                        let ret = "data";
                        for (let k of stack) {
                            ret += "[" + this.to_string(k) + "]";
                        }
                        return ret;
                    },
                    get_data_type: function (_data) {
                        if (_data === undefined) {
                            return "Undefined";
                        }
                        if (_data.type === undefined) {
                            if (_data instanceof Array) {
                                return "Array";
                            } else if (typeof _data == "string") {
                                return "String";
                            } else if (typeof _data == "number") {
                                return "Number";
                            } else {
                                return "Object";
                            }
                        } else {
                            return _data.type;
                        }
                    },

                    data_changed: function () {
                        this.$emit("data_change", {
                            stack: this.stack,
                            value: this.get_data_type(this.current_data) === "Number" ? this.tmp_value - 0 : this.tmp_value
                        });
                    },

                    add_item_to_array: function (arr, item) {
                        let ret = [];
                        for (let i of arr) {
                            ret.push(i);
                        }
                        ret.push(item);
                        return ret;
                    },
                    to_string: function (obj) {
                        if (typeof obj == "string") {
                            return '"' + obj + "'";
                        }
                        return obj;
                    },

                    add_new: function () {
                        let _this = this;

                        let _add_new = function(){
                            if (_this.get_data_type(_this.current_data) === "Array") {
                                _this.$emit("add_new_data", {
                                    src_type: "Array",
                                    key: _this.new_key_name,
                                    item_type: _this.new_type,
                                    stack: _this.stack
                                });
                            } else if (_this.get_data_type(_this.current_data) === "Object") {
                                if (_this.new_key_name.length === 0) {
                                    layui.use("layer", function () {
                                        let layer = layui.layer;
                                        layer.msg("请先输入属性名称！", {icon: 2});
                                    })
                                } else if (_this.current_data[_this.new_key_name] !== undefined) {
                                    layui.use("layer", function () {
                                        let layer = layui.layer;
                                        layer.msg("属性" + _this.new_key_name + "已存在，请使用其他属性名称", {icon: 2});
                                    })
                                } else {
                                    _this.$emit("add_new_data", {
                                        src_type: "Object",
                                        key: _this.new_key_name,
                                        item_type: _this.new_type,
                                        stack: _this.stack
                                    });
                                }
                            }
                        };

                        layui.use("layer", function () {
                            let layer = layui.layer;
                            layer.open({
                                type: 1 //此处以iframe举例
                                ,title: "请选择要添加的类型"
                                ,area: ['450px', '120px']
                                ,shade: 0
                                ,maxmin: false
                                ,content: ''
                                ,btn: ['取消','数字', '字符串', '数组', '对象']
                                ,btn2: function(){
                                    _this.new_type = "Number";
                                    _add_new();
                                }
                                ,btn3: function(){
                                    _this.new_type = "String";
                                    _add_new();
                                }
                                ,btn4: function(){
                                    _this.new_type = "Array";
                                    _add_new();
                                }
                                , btn5: function () {
                                    _this.new_type = "Object";
                                    _add_new();
                                }
                                , yes: function () {
                                    layer.closeAll();
                                }
                                ,btnAlign: 'c'
                                ,zIndex: layer.zIndex //重点1
                                ,success: function(layero){
                                    layer.setTop(layero); //重点2
                                }
                            });
                        });
                    }
                },

                template: `
                <div class="layui-form layui-form-pane">
                    <div class="layui-collapse" lay-accordion="" lay-filter="test">
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">
                              <span>[[ make_index_string(stack) ]]
                                  <!--<i class="layui-icon layui-colla-icon">[[ expand?"":"" ]]</i>-->
                              </span>
                            </h2>
                            <div class="layui-colla-content layui-show">
                                <div v-if="get_data_type(current_data) == 'Object' || get_data_type(current_data) == 'Array'">
                                    <table class="layui-table" lay-size="sm">
                                        <colgroup>
                                            <col width="100">
                                            <col>
                                            <col width="50" v-if="dev">
                                        </colgroup>
                                        <thead>
                                        <tr>
                                            <th>索引</th>
                                            <th>值</th>
                                            <th v-if="dev">操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr v-for="(value,key) in current_data">
                                            <td>[[ key ]]</td>
                                            <td>
                                                <data_form :current_data=value :stack="add_item_to_array(stack, key)"
                                                           @data_change="$emit('data_change', $event);"
                                                           @delete_data="$emit('delete_data', $event)"
                                                           @add_new_data="$emit('add_new_data', $event)" :dev="dev"></data_form>
                                            </td>
                                            <td>
                                                <button @click="$emit('delete_data', {stack:stack, index:key})" v-if="dev"
                                                    class="layui-btn layui-btn-danger layui-btn-sm">
                                                    <i class="layui-icon" title="删除"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                    <div class="layui-inline">
                                        <div class="layui-input-inline">
                                             <input type="text" v-if="dev && get_data_type(current_data) == 'Object'"
                                                                 v-model="new_key_name" placeholder="新属性名" class="layui-input">
                                        </div>
                                        <div class="layui-input-inline">
                                            <button @click="add_new" class="layui-btn layui-btn-sm" v-if="dev">
                                            <i class="layui-icon" title="新增"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div v-else-if="get_data_type(current_data) == 'String'">
                                    <div class="layui-form-item layui-form-text">
                                        <div class="layui-input-block" v-show="single_line">
                                            <input type="text" v-model="tmp_value" autocomplete="off" placeholder="请输入内容"
                                                   class="layui-input">
                                        </div>
                                        <div class="layui-input-block" v-show="!single_line">
                                            <textarea placeholder="请输入内容" v-model="tmp_value" class="layui-textarea"></textarea>
                                        </div>
                                    </div>
                                    <button class="layui-btn layui-btn-radius layui-btn-sm" @click="single_line=!single_line">[[
                                        single_line?"多行编辑":"单行编辑" ]]
                                    </button>
                                    <button class="layui-btn layui-btn-normal layui-btn-radius layui-btn-sm" @click="data_changed">
                                        确认修改
                                    </button>
                                </div>
                                <div v-else-if="get_data_type(current_data) == 'Number'">
                                    <div class="layui-form-item layui-form-text">
                                        <div class="layui-input-inline">
                                            <input type="number" name="phone" lay-verify="required|number" placeholder="请输入数字"
                                                   autocomplete="off" class="layui-input" v-model="tmp_value">
                                        </div>
                                    </div>
                                    <button class="layui-btn layui-btn-normal layui-btn-radius layui-btn-sm" @click="data_changed">
                                        确认修改
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `
            }
        );


        let app = new Vue({
            el: "#app",
            data: {
                type_data:{{type_data|tojson}},
                title:{{title|tojson}},
                dev:{{dev|tojson}},
                user:{{user|tojson}},
                footer:{{footer|tojson}},

                page_type: "",
            },
            delimiters: ["[[", "]]"],
            components: {
                data_form: data_form
            },
            methods: {
                on_add_new_data: function (data) {
                    let _this = this;
                    layui.use(["jquery", "layer"], function () {
                        let $ = layui.jquery;
                        let layer = layui.layer;

                        $.post("add_data", {"data": JSON.stringify(data)}, function (res) {
                            let ret = JSON.parse(res);
                            if (ret.code !== 0) {
                                layer.msg("错误：" + ret.code, {icon: 2});
                                return;
                            }
                            let v = _this.type_data;
                            for (let key of data.stack) {
                                v = v[key];
                            }
                            let value = null;
                            if (data.item_type === "Number") {
                                value = 0;
                            } else if (data.item_type === "String") {
                                value = "";
                            } else if (data.item_type === "Array") {
                                value = [];
                            } else {
                                value = {};
                            }
                            if (data.src_type === "Array") {
                                v.push(value);
                            } else if (data.src_type === "Object") {
                                Vue.set(v, data.key, value);
                            }
                            layer.msg("添加成功", {icon: 1});
                        }).fail(function (res) {
                            layer.msg("添加失败", {icon: 2});
                        });
                    });
                },

                on_data_change: function (data) {
                    let _this = this;
                    layui.use(["layer", "jquery"], function () {
                        let layer = layui.layer;
                        let $ = layui.jquery;
                        let v = _this.type_data;
                        for (let key of data.stack.slice(0, data.stack.length - 1)) {
                            v = v[key];
                        }
                        let key = data.stack[data.stack.length - 1];
                        layer.confirm("确认将值 " + v[key] + " 更新为 " + data.value + " ?", {
                            btn: ['确认', '取消'] //按钮
                        }, function () {
                            $.post("data_change", {"data": JSON.stringify(data)}, function (res) {
                                let ret = JSON.parse(res);
                                if (ret.code !== 0) {
                                    layer.msg("错误：" + ret.code, {icon: 2});
                                    return;
                                }

                                Vue.set(v, key, data.value);
                                layer.msg('更新成功', {icon: 1});
                            }).fail(function (res) {
                                layer.msg('更新失败', {icon: 2});
                            });
                        }, function () {
                        });
                    });
                },

                on_delete_data: function (data) {
                    let _this = this;
                    layui.use(["jquery", "layer"], function () {
                        let $ = layui.jquery;
                        let layer = layui.layer;

                        let v = _this.type_data;
                        for (let key of data.stack) {
                            v = v[key];
                        }

                        layer.confirm("确认将 " + data.index + " 删除 ?", {
                            btn: ['确认', '取消'] //按钮
                        }, function () {
                            $.post("delete_data", {"data": JSON.stringify(data)}, function (res) {
                                let ret = JSON.parse(res);
                                if (ret.code !== 0) {
                                    layer.msg("错误：" + ret.code, {icon: 2});
                                    return;
                                }
                                Vue.delete(v, data.index);
                                layer.msg('删除成功', {icon: 1});
                            }).fail(function () {
                                layer.msg('删除失败', {icon: 1});
                            })
                        }, function () {
                        });
                    });
                },
            },
        });


        element.init();
        form.render();
    });


</script>


</body>
</html>
